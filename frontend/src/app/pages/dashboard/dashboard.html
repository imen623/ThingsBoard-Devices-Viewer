<div class="layout">
  <header>
    <div class="container">
      <h3>My Devices</h3>
      <button class="new-device" (click)="openAddDeviceModal()">
        Add Device
      </button>
    </div>
  </header>
  <main class="layout-column">
    <div class="device-list" *ngIf="!loading && devices.length > 0">
      <mat-card class="device-item" *ngFor="let device of devices">
        <mat-card-title>{{ device.name }}</mat-card-title>
        <p style="font-size: 11px; color: gray">
          ID:{{ device.thingsboard_device_id }}
        </p>

        <mat-card-content>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              width: 100%;
            "
          >
            <div>
              <p class="mat-subheading-1" style="margin: 0; line-height: 1.5">
                Type: {{ device.type }}
              </p>
              <p class="mat-subheading-1" style="margin: 0; line-height: 1.5">
                Telemetry: {{ device.info }}
              </p>
            </div>

            <div class="telemetry-info" style="text-align: right">
              <mat-progress-spinner
                *ngIf="telemetryLoading.get(device.thingsboard_device_id)"
                diameter="24"
                mode="indeterminate"
              ></mat-progress-spinner>

              <div
                *ngIf="telemetryError.get(device.thingsboard_device_id)"
                class="error-message"
              >
                {{ telemetryError.get(device.thingsboard_device_id) }}
              </div>

              <!-- showing unit depending on info (key) -->
              <div
                *ngIf="
                  !telemetryLoading.get(device.thingsboard_device_id) &&
                  !telemetryError.get(device.thingsboard_device_id)
                "
                class="telemetry-value"
              >
                <ng-container [ngSwitch]="device.info">
                  <span *ngSwitchCase="'temperature'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} Â°C
                  </span>
                  <span *ngSwitchCase="'humidity'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} %
                  </span>
                  <span *ngSwitchCase="'pressure'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} hPa
                  </span>
                  <span *ngSwitchCase="'light'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} lux
                  </span>
                  <span *ngSwitchCase="'voltage'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} V
                  </span>
                  <span *ngSwitchCase="'current'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} A
                  </span>
                  <span *ngSwitchCase="'energy'">
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }} kWh
                  </span>
                  <span *ngSwitchCase="'occupancy'">
                    {{
                      deviceTelemetry.get(device.thingsboard_device_id)
                        ? "Occupied"
                        : "Vacant"
                    }}
                  </span>
                  <span *ngSwitchDefault>
                    {{ deviceTelemetry.get(device.thingsboard_device_id) }}
                  </span>
                </ng-container>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div *ngIf="!loading && devices.length === 0">
      <p>No devices added yet. Click "Add Device" to get started!</p>
    </div>
  </main>

  <!-- Add Device Modal -->
  <div *ngIf="showAddDeviceModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Add New Device</h2>
      <form (ngSubmit)="saveNewDevice()">
        <div class="form-group">
          <label>Device Name:</label>
          <input
            type="text"
            [(ngModel)]="newDevice.name"
            name="deviceName"
            required
          />
        </div>
        <div class="form-group">
          <label>Device ID (ThingsBoard):</label>
          <input
            type="text"
            [(ngModel)]="newDevice.id"
            name="deviceId"
            required
          />
          <!-- Display specific ID error message -->
          <div *ngIf="idError" class="error-message">
            {{ idErrorMessage || "Invalid Device ID" }}
          </div>
        </div>
        <div class="form-group">
          <label>Device Type:</label>
          <select [(ngModel)]="newDevice.type" name="deviceType" required>
            <option value="indoor">Indoor</option>
            <option value="outdoor">Outdoor</option>
          </select>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="cancel-btn"
            (click)="closeAddDeviceModal()"
          >
            Cancel
          </button>
          <button type="submit" class="confirm-btn" [disabled]="savingDevice">
            {{ savingDevice ? "Saving..." : "Save" }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
